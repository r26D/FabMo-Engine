<!DOCTYPE html><html lang="en"><head><title>routes/dashboard</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/dashboard"><meta name="groc-project-path" content="routes/dashboard.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">routes/dashboard.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>);
<span class="hljs-keyword">var</span> restify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'restify'</span>);
<span class="hljs-keyword">var</span> dashboard = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../dashboard'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../util'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> upload = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>).upload;</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {get} /apps List Apps, apiGroup Dashboard, apiDescription Get detailed information about all installed apps, apiSuccess {String} status <code>success</code>, apiSuccess {Object} data Response data, apiSuccess {Object[]} data.apps List of app objects, apiSuccess {String} data.apps.name Human-readable app name, apiSuccess {String} data.apps.app_url Root URL for the app, apiSuccess {String} data.apps.app_path App path (Used internally by the engine), apiSuccess {String} data.apps.icon_path URL of app icon, apiSuccess {String} data.apps.icon_background_color CSS color value of the app icon, and apiSuccess {String} data.apps.id Unique ID of this app (used in app URLs)</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> getApps = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
	<span class="hljs-keyword">var</span> answer = {
		status:<span class="hljs-string">"success"</span>,
		data : {apps : dashboard.getAppList()}
	};
	res.json(answer);
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {get} /apps/:id App info, apiGroup Dashboard, apiDescription Get detailed information about the specified app, apiParam {String} id ID of requested app, apiSuccess {String} status <code>success</code>, apiSuccess {Object} data Response data, apiSuccess {Object} data.app App object, apiSuccess {String} data.app.name Human-readable app name, apiSuccess {String} data.app.app_url Root URL for the app, apiSuccess {String} data.app.app_path App path (Used internally by the engine), apiSuccess {String} data.app.icon_path URL of app icon, apiSuccess {String} data.app.icon_background_color CSS color value of the app icon, and apiSuccess {String} data.app.id Unique ID of this app (used in app URLs)</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> getAppInfo = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
	log.info(<span class="hljs-string">"Getting app "</span> + req.params.id);
	<span class="hljs-keyword">var</span> answer = {
		status:<span class="hljs-string">"success"</span>,
		data : {app : dashboard.getAppIndex()[req.params.id]}
	};
	res.json(answer);
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {get} /apps/:id/config App configuration, apiGroup Dashboard, apiDescription Get detailed information about the specified app, apiParam {String} id ID of requested app, apiSuccess {String} status <code>success</code>, apiSuccess {Object} data Response data, and apiSuccess {Object} data.config App configuration data object</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> getAppConfig = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">var</span> answer = {
            status:<span class="hljs-string">"success"</span>,
            data : {config : dashboard.getAppConfig(req.params.id)}
        };
    } <span class="hljs-keyword">catch</span>(e) {
        <span class="hljs-keyword">var</span> answer = {
            status:<span class="hljs-string">"error"</span>,
            message : <span class="hljs-built_in">String</span>(e)
        };
    }
    res.json(answer);
}</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {post} /apps/:id/config Update app configuration, apiGroup Dashboard, apiDescription Replace the specified app configuration with the POSTed object into the engine configuration.  Configuration updates take effect immediately., and apiParam {Object} config Generic JSON formatted object to store as the apps configuration.</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> postAppConfig = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> new_config = {};
    <span class="hljs-keyword">var</span> answer;
    dashboard.setAppConfig(req.params.id, req.params.config, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            <span class="hljs-keyword">var</span> answer = {
                status:<span class="hljs-string">"error"</span>,
                message : <span class="hljs-built_in">String</span>(e)
            };
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> answer = {
                status:<span class="hljs-string">"success"</span>,
                data : {}
            };
        }
        res.json(answer);

    }.bind(<span class="hljs-keyword">this</span>))
}</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {delete} /apps/:id Delete App, apiDescription Delete the specified app, and apiGroup Dashboard</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> deleteApp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    log.info(<span class="hljs-string">"Deleting app "</span> + req.params.id);
    dashboard.deleteApp(req.params.id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        <span class="hljs-keyword">var</span> answer;
        <span class="hljs-keyword">if</span>(err) {
            answer = {
                status:<span class="hljs-string">"error"</span>,
                message : err
            };
        } <span class="hljs-keyword">else</span> {
            answer = {
                status:<span class="hljs-string">"success"</span>,
                data : {app : result}
            };
        }
        res.json(answer);
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {get} /apps/:id/files List App Files, apiGroup Dashboard, apiParam {String} id ID of requested app, and apiSuccess {Object} root Root of directory tree</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> listAppFiles = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
	log.info(<span class="hljs-string">"Listing files"</span>);
	id = req.params.id;

	files = dashboard.getAppFiles(id);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add URL attributes to all of the leaves of the file tree</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add_urls</span>(<span class="hljs-params">node</span>) </span>{
		<span class="hljs-keyword">if</span>(node.type === <span class="hljs-string">'file'</span>) {
			node.url = <span class="hljs-string">'/approot'</span> + node.path;
		}
		<span class="hljs-keyword">if</span>(node.children) {
			node.children.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">node</span>) </span>{
				add_urls(node);
			});
		}
	}

	add_urls(files);

		<span class="hljs-keyword">var</span> answer = {
		status:<span class="hljs-string">"success"</span>,
		data : {files : files}
	};
	res.json(answer);
};

<span class="hljs-keyword">var</span> submitApp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    upload(req, res, next, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, uploads</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Multiple apps can be submitted at once.  Process each of them in turn.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">async</span>.map(uploads.files, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">upload_data, callback</span>) </span>{
            <span class="hljs-keyword">var</span> file = upload_data.file;
            <span class="hljs-keyword">if</span>(file &amp;&amp; util.allowedAppFile(file.name)) {
                dashboard.installAppArchive(file.path, file.name, callback);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(file) {
                callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Cannot accept '</span> + file.name + <span class="hljs-string">': Incorrect file format.'</span>));
            } <span class="hljs-keyword">else</span> {
                callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Bad request.'</span>));
            }
        }, 
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all_finished</span>(<span class="hljs-params">err, apps</span>) </span>{
            <span class="hljs-keyword">if</span>(err) {
                <span class="hljs-keyword">return</span> res.json({
                    status: <span class="hljs-string">"error"</span>,
                    message : err.message
                });
            }
            <span class="hljs-keyword">return</span> res.json({
                status: <span class="hljs-string">"success"</span>,
                data : {
                    status : <span class="hljs-string">"complete"</span>, 
                    data : {<span class="hljs-string">"apps"</span> : apps}
                }
            });
        }); <span class="hljs-comment">// async.map</span>
    }); <span class="hljs-comment">// upload</span>
}; <span class="hljs-comment">// submitApp</span>

<span class="hljs-keyword">var</span> updater = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> host = req.headers.host.split(<span class="hljs-string">':'</span>)[<span class="hljs-number">0</span>].trim(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">var</span> url = <span class="hljs-string">'http://'</span> + host + <span class="hljs-string">':'</span> + (config.engine.get(<span class="hljs-string">'server_port'</span>) + <span class="hljs-number">1</span>);
    res.redirect(<span class="hljs-number">303</span>, url, next);   
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">server</span>) </span>{
    server.post(<span class="hljs-string">'/apps'</span>, submitApp);
    server.get(<span class="hljs-string">'/apps'</span>, getApps);
    server.get(<span class="hljs-string">'/apps/:id'</span>, getAppInfo);
    server.get(<span class="hljs-string">'/apps/:id/config'</span>, getAppConfig);
    server.post(<span class="hljs-string">'/apps/:id/config'</span>, postAppConfig);
    server.del(<span class="hljs-string">'/apps/:id'</span>, deleteApp);
    server.get(<span class="hljs-string">'/apps/:id/files'</span>, listAppFiles);
    server.get(<span class="hljs-regexp">/\/approot\/?.*/</span>, restify.serveStatic({
        directory: config.getDataDir(<span class="hljs-string">'approot'</span>),
    }));
    server.get(<span class="hljs-string">'/updater'</span>, updater);

};</div></div></div></div></body></html>